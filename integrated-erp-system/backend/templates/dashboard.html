<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated ERP System - Dashboard</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .nav-tab:hover {
            background: #f0f0f0;
        }

        .nav-tab.active:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .module-content {
            display: none;
        }

        .module-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            opacity: 0.9;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-open {
            background: #ffeb3b;
            color: #f57f17;
        }

        .status-in-progress {
            background: #2196f3;
            color: white;
        }

        .status-critical {
            background: #f44336;
            color: white;
        }

        .status-high {
            background: #ff9800;
            color: white;
        }

        .status-medium {
            background: #4caf50;
            color: white;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .realtime-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .data-table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üé¨ Integrated ERP System</h1>
            <p>Complete working ERP with AI-powered features and real-time updates</p>
            <div style="margin-top: 10px;">
                <span class="realtime-indicator"></span>
                <span>Real-time updates active</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showModule('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showModule('maintenance')">üîß Maintenance</button>
            <button class="nav-tab" onclick="showModule('supply-chain')">üì¶ Supply Chain</button>
            <button class="nav-tab" onclick="showModule('crm')">üë• CRM</button>
            <button class="nav-tab" onclick="showModule('analytics')">ü§ñ AI Analytics</button>
            <button class="nav-tab" onclick="showModule('realtime')">‚ö° Real-time</button>
        </div>

        <div class="content">
            <!-- Dashboard Module -->
            <div id="dashboard" class="module-content active">
                <h2>üìä Executive Dashboard</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="total-tickets">-</div>
                        <div class="metric-label">Total Tickets</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="open-tickets">-</div>
                        <div class="metric-label">Open Tickets</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="sla-compliance">-</div>
                        <div class="metric-label">SLA Compliance</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="inventory-value">-</div>
                        <div class="metric-label">Inventory Value</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Performance Trends</h3>
                    <canvas id="performanceChart" width="400" height="200"></canvas>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn" onclick="refreshDashboard()">üîÑ Refresh Data</button>
                    <button class="btn" onclick="generateReport()">üìä Generate Report</button>
                </div>
            </div>

            <!-- Maintenance Module -->
            <div id="maintenance" class="module-content">
                <h2>üîß Enhanced Maintenance Module</h2>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="showCreateTicketForm()">üìù Create New Ticket</button>
                    <button class="btn btn-secondary" onclick="loadTickets()">üîÑ Refresh Tickets</button>
                </div>

                <div id="create-ticket-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>Create New Ticket</h3>
                    <div class="form-group">
                        <label>Subject:</label>
                        <input type="text" id="ticket-subject" placeholder="Enter ticket subject">
                    </div>
                    <div class="form-group">
                        <label>Description:</label>
                        <textarea id="ticket-description" placeholder="Enter detailed description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Priority:</label>
                        <select id="ticket-priority">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Customer:</label>
                        <select id="ticket-customer">
                            <option value="CUST-001">Acme Corporation</option>
                            <option value="CUST-002">TechStart Inc</option>
                            <option value="CUST-003">Global Solutions Ltd</option>
                        </select>
                    </div>
                    <button class="btn" onclick="createTicket()">‚úÖ Create Ticket</button>
                    <button class="btn btn-secondary" onclick="hideCreateTicketForm()">‚ùå Cancel</button>
                </div>

                <div id="tickets-list">
                    <div class="loading">Loading tickets...</div>
                </div>
            </div>

            <!-- Supply Chain Module -->
            <div id="supply-chain" class="module-content">
                <h2>üì¶ Intelligent Supply Chain</h2>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="loadInventory()">üì¶ View Inventory</button>
                    <button class="btn" onclick="generateRecommendations()">üß† Generate AI Recommendations</button>
                    <button class="btn btn-secondary" onclick="loadRecommendations()">üìã View Recommendations</button>
                </div>

                <div id="inventory-list">
                    <div class="loading">Loading inventory...</div>
                </div>

                <div id="recommendations-list" style="display: none;">
                    <h3>ü§ñ AI Reorder Recommendations</h3>
                    <div class="loading">Loading recommendations...</div>
                </div>
            </div>

            <!-- CRM Module -->
            <div id="crm" class="module-content">
                <h2>üë• Enhanced CRM Module</h2>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="loadCustomers()">üë• View Customers</button>
                    <button class="btn" onclick="analyzeAllCustomers()">üîç Analyze All Customers</button>
                    <button class="btn btn-secondary" onclick="generateCRMReport()">üìä Generate CRM Report</button>
                </div>

                <div id="customers-list">
                    <div class="loading">Loading customers...</div>
                </div>
            </div>

            <!-- Analytics Module -->
            <div id="analytics" class="module-content">
                <h2>ü§ñ AI Analytics Dashboard</h2>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="loadAnalytics()">üß† Load AI Insights</button>
                    <button class="btn" onclick="runPredictions()">üîÆ Run Predictions</button>
                    <button class="btn btn-secondary" onclick="exportAnalytics()">üìä Export Analytics</button>
                </div>

                <div id="analytics-content">
                    <div class="loading">Loading AI analytics...</div>
                </div>
            </div>

            <!-- Real-time Module -->
            <div id="realtime" class="module-content">
                <h2>‚ö° Real-time Features</h2>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="startRealtimeDemo()">‚ö° Start Real-time Demo</button>
                    <button class="btn" onclick="simulateUpdates()">üîÑ Simulate Updates</button>
                    <button class="btn btn-secondary" onclick="clearRealtimeLog()">üóëÔ∏è Clear Log</button>
                </div>

                <div id="realtime-log" style="background: #f8f9fa; padding: 20px; border-radius: 10px; max-height: 400px; overflow-y: auto;">
                    <h3>üì° Real-time Activity Log</h3>
                    <div id="realtime-messages">
                        <div>Waiting for real-time updates...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Global state
        let currentData = {
            tickets: [],
            customers: [],
            inventory: [],
            recommendations: [],
            analytics: {}
        };

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
            showNotification('üîÑ Connected to real-time updates', 'success');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            showNotification('‚ö†Ô∏è Disconnected from server', 'warning');
        });

        socket.on('ticket_created', function(ticket) {
            addRealtimeMessage(`üé´ New ticket created: ${ticket.subject}`);
            if (document.getElementById('maintenance').classList.contains('active')) {
                loadTickets();
            }
        });

        socket.on('ticket_updated', function(ticket) {
            addRealtimeMessage(`üîÑ Ticket updated: ${ticket.subject} - Status: ${ticket.status}`);
            if (document.getElementById('maintenance').classList.contains('active')) {
                loadTickets();
            }
        });

        socket.on('recommendation_approved', function(rec) {
            addRealtimeMessage(`‚úÖ Recommendation approved: ${rec.item_name} - Qty: ${rec.recommended_qty}`);
        });

        socket.on('customer_analyzed', function(insights) {
            addRealtimeMessage(`üîç Customer analysis completed: ${insights.customer_id}`);
        });

        // Module navigation
        function showModule(moduleId) {
            // Hide all modules
            document.querySelectorAll('.module-content').forEach(module => {
                module.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected module
            document.getElementById(moduleId).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load module data
            switch(moduleId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'maintenance':
                    loadTickets();
                    break;
                case 'supply-chain':
                    loadInventory();
                    break;
                case 'crm':
                    loadCustomers();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'realtime':
                    startRealtimeDemo();
                    break;
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                // Load tickets for metrics
                const ticketsResponse = await fetch('/api/maintenance/tickets');
                const ticketsData = await ticketsResponse.json();
                
                if (ticketsData.success) {
                    const tickets = ticketsData.data;
                    document.getElementById('total-tickets').textContent = tickets.length;
                    document.getElementById('open-tickets').textContent = tickets.filter(t => t.status === 'Open').length;
                    document.getElementById('sla-compliance').textContent = '94%';
                    document.getElementById('inventory-value').textContent = '$2.4M';
                }
                
                // Initialize performance chart
                initPerformanceChart();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('‚ùå Error loading dashboard', 'error');
            }
        }

        function initPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Response Time (hours)',
                        data: [3.2, 2.8, 2.5, 2.3, 2.1, 2.3],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'SLA Compliance (%)',
                        data: [85, 88, 91, 93, 94, 94],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function refreshDashboard() {
            loadDashboard();
            showNotification('üîÑ Dashboard refreshed', 'success');
        }

        function generateReport() {
            showNotification('üìä Generating comprehensive report...', 'success');
            setTimeout(() => {
                showNotification('‚úÖ Report generated successfully', 'success');
            }, 2000);
        }

        // Maintenance functions
        async function loadTickets() {
            try {
                const response = await fetch('/api/maintenance/tickets');
                const data = await response.json();
                
                if (data.success) {
                    currentData.tickets = data.data;
                    displayTickets(data.data);
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                showNotification('‚ùå Error loading tickets', 'error');
            }
        }

        function displayTickets(tickets) {
            const container = document.getElementById('tickets-list');
            
            if (tickets.length === 0) {
                container.innerHTML = '<div class="loading">No tickets found</div>';
                return;
            }
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Subject</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>AI Sentiment</th>
                            <th>SLA Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            tickets.forEach(ticket => {
                const priorityClass = ticket.priority.toLowerCase();
                const statusClass = ticket.status.toLowerCase().replace(' ', '-');
                const sentimentLabel = ticket.ai_sentiment > 0.1 ? 'Positive' : ticket.ai_sentiment < -0.1 ? 'Negative' : 'Neutral';
                
                html += `
                    <tr>
                        <td>${ticket.id}</td>
                        <td>${ticket.subject}</td>
                        <td><span class="status-badge status-${priorityClass}">${ticket.priority}</span></td>
                        <td><span class="status-badge status-${statusClass}">${ticket.status}</span></td>
                        <td>${sentimentLabel} (${ticket.ai_sentiment})</td>
                        <td>${ticket.sla_status}</td>
                        <td>${new Date(ticket.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn" onclick="updateTicket('${ticket.id}')">Update</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showCreateTicketForm() {
            document.getElementById('create-ticket-form').style.display = 'block';
        }

        function hideCreateTicketForm() {
            document.getElementById('create-ticket-form').style.display = 'none';
        }

        async function createTicket() {
            const subject = document.getElementById('ticket-subject').value;
            const description = document.getElementById('ticket-description').value;
            const priority = document.getElementById('ticket-priority').value;
            const customer = document.getElementById('ticket-customer').value;
            
            if (!subject || !description) {
                showNotification('‚ùå Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/maintenance/tickets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject,
                        description,
                        priority,
                        customer_id: customer
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Ticket created successfully', 'success');
                    hideCreateTicketForm();
                    loadTickets();
                    
                    // Clear form
                    document.getElementById('ticket-subject').value = '';
                    document.getElementById('ticket-description').value = '';
                } else {
                    showNotification('‚ùå Error creating ticket', 'error');
                }
            } catch (error) {
                console.error('Error creating ticket:', error);
                showNotification('‚ùå Error creating ticket', 'error');
            }
        }

        function updateTicket(ticketId) {
            const ticket = currentData.tickets.find(t => t.id === ticketId);
            if (ticket) {
                const newStatus = ticket.status === 'Open' ? 'In Progress' : 'Closed';
                
                fetch(`/api/maintenance/tickets/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`‚úÖ Ticket ${ticketId} updated to ${newStatus}`, 'success');
                        loadTickets();
                    }
                })
                .catch(error => {
                    console.error('Error updating ticket:', error);
                    showNotification('‚ùå Error updating ticket', 'error');
                });
            }
        }

        // Supply Chain functions
        async function loadInventory() {
            try {
                const response = await fetch('/api/supply-chain/inventory');
                const data = await response.json();
                
                if (data.success) {
                    currentData.inventory = data.data;
                    displayInventory(data.data);
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
                showNotification('‚ùå Error loading inventory', 'error');
            }
        }

        function displayInventory(inventory) {
            const container = document.getElementById('inventory-list');
            
            let html = `
                <h3>üì¶ Current Inventory</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>Name</th>
                            <th>Current Stock</th>
                            <th>Reserved</th>
                            <th>Projected</th>
                            <th>Reorder Level</th>
                            <th>Status</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            inventory.forEach(item => {
                const status = item.current_stock <= item.reorder_level ? '‚ö†Ô∏è Low Stock' : '‚úÖ Good';
                const statusClass = item.current_stock <= item.reorder_level ? 'warning' : 'success';
                
                html += `
                    <tr>
                        <td>${item.item_code}</td>
                        <td>${item.name}</td>
                        <td>${item.current_stock}</td>
                        <td>${item.reserved}</td>
                        <td>${item.projected}</td>
                        <td>${item.reorder_level}</td>
                        <td><span class="status-badge status-${statusClass}">${status}</span></td>
                        <td>$${item.total_value.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function generateRecommendations() {
            try {
                const response = await fetch('/api/supply-chain/recommendations');
                const data = await response.json();
                
                if (data.success) {
                    currentData.recommendations = data.data;
                    displayRecommendations(data.data);
                    showNotification('üß† AI recommendations generated', 'success');
                }
            } catch (error) {
                console.error('Error generating recommendations:', error);
                showNotification('‚ùå Error generating recommendations', 'error');
            }
        }

        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendations-list');
            container.style.display = 'block';
            
            if (recommendations.length === 0) {
                container.innerHTML = '<div class="loading">No recommendations available</div>';
                return;
            }
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Recommended Qty</th>
                            <th>Unit Cost</th>
                            <th>Total Cost</th>
                            <th>Confidence</th>
                            <th>Urgency</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recommendations.forEach(rec => {
                const urgencyClass = rec.urgency > 0.7 ? 'critical' : rec.urgency > 0.4 ? 'high' : 'medium';
                
                html += `
                    <tr>
                        <td>${rec.item_name}</td>
                        <td>${rec.recommended_qty}</td>
                        <td>$${rec.unit_cost}</td>
                        <td>$${rec.total_cost.toLocaleString()}</td>
                        <td>${(rec.confidence * 100).toFixed(1)}%</td>
                        <td><span class="status-badge status-${urgencyClass}">${(rec.urgency * 100).toFixed(1)}%</span></td>
                        <td>
                            <button class="btn" onclick="approveRecommendation('${rec.item_code}')">‚úÖ Approve</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function loadRecommendations() {
            document.getElementById('recommendations-list').style.display = 'block';
            if (currentData.recommendations.length > 0) {
                displayRecommendations(currentData.recommendations);
            } else {
                generateRecommendations();
            }
        }

        function approveRecommendation(itemCode) {
            showNotification(`‚úÖ Recommendation approved for ${itemCode}`, 'success');
            addRealtimeMessage(`‚úÖ Recommendation approved: ${itemCode}`);
        }

        // CRM functions
        async function loadCustomers() {
            try {
                const response = await fetch('/api/crm/customers');
                const data = await response.json();
                
                if (data.success) {
                    currentData.customers = data.data;
                    displayCustomers(data.data);
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showNotification('‚ùå Error loading customers', 'error');
            }
        }

        function displayCustomers(customers) {
            const container = document.getElementById('customers-list');
            
            let html = `
                <h3>üë• Customer Analytics</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Type</th>
                            <th>Health Score</th>
                            <th>Churn Risk</th>
                            <th>Last Activity</th>
                            <th>Satisfaction</th>
                            <th>Total Spent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            customers.forEach(customer => {
                const churnClass = customer.churn_risk === 'High' ? 'critical' : customer.churn_risk === 'Medium' ? 'high' : 'medium';
                const healthClass = customer.health_score > 80 ? 'success' : customer.health_score > 60 ? 'medium' : 'critical';
                
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.type}</td>
                        <td><span class="status-badge status-${healthClass}">${customer.health_score}%</span></td>
                        <td><span class="status-badge status-${churnClass}">${customer.churn_risk}</span></td>
                        <td>${new Date(customer.last_activity).toLocaleDateString()}</td>
                        <td>${customer.satisfaction}/5</td>
                        <td>$${customer.total_spent.toLocaleString()}</td>
                        <td>
                            <button class="btn" onclick="analyzeCustomer('${customer.id}')">üîç Analyze</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function analyzeCustomer(customerId) {
            try {
                const response = await fetch(`/api/crm/customers/${customerId}/analyze`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`üîç Customer ${customerId} analyzed successfully`, 'success');
                    addRealtimeMessage(`üîç Customer analysis completed: ${customerId}`);
                }
            } catch (error) {
                console.error('Error analyzing customer:', error);
                showNotification('‚ùå Error analyzing customer', 'error');
            }
        }

        function analyzeAllCustomers() {
            showNotification('üîç Analyzing all customers...', 'success');
            currentData.customers.forEach(customer => {
                analyzeCustomer(customer.id);
            });
        }

        function generateCRMReport() {
            showNotification('üìä Generating CRM report...', 'success');
            setTimeout(() => {
                showNotification('‚úÖ CRM report generated', 'success');
            }, 2000);
        }

        // Analytics functions
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics/insights');
                const data = await response.json();
                
                if (data.success) {
                    currentData.analytics = data.data;
                    displayAnalytics(data.data);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                showNotification('‚ùå Error loading analytics', 'error');
            }
        }

        function displayAnalytics(analytics) {
            const container = document.getElementById('analytics-content');
            
            let html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${(analytics.performance_metrics.ai_accuracy * 100).toFixed(1)}%</div>
                        <div class="metric-label">AI Accuracy</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">$${analytics.performance_metrics.cost_savings.toLocaleString()}</div>
                        <div class="metric-label">Cost Savings</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(analytics.performance_metrics.automation_rate * 100).toFixed(1)}%</div>
                        <div class="metric-label">Automation Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${analytics.performance_metrics.user_satisfaction}/5</div>
                        <div class="metric-label">User Satisfaction</div>
                    </div>
                </div>
                
                <h3>üö® Predictive Maintenance Alerts</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Equipment</th>
                            <th>Prediction</th>
                            <th>Confidence</th>
                            <th>Recommended Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            analytics.predictive_maintenance.alerts.forEach(alert => {
                html += `
                    <tr>
                        <td>${alert.equipment}</td>
                        <td>${alert.prediction}</td>
                        <td>${(alert.confidence * 100).toFixed(1)}%</td>
                        <td>${alert.recommended_action}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            html += `
                <h3>üìà Demand Forecasting</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Predicted Demand</th>
                            <th>Confidence</th>
                            <th>Timeframe</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            analytics.demand_forecasting.predictions.forEach(prediction => {
                html += `
                    <tr>
                        <td>${prediction.item_code}</td>
                        <td>${prediction.predicted_demand}</td>
                        <td>${(prediction.confidence * 100).toFixed(1)}%</td>
                        <td>${prediction.timeframe}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function runPredictions() {
            showNotification('üîÆ Running AI predictions...', 'success');
            setTimeout(() => {
                showNotification('‚úÖ Predictions completed', 'success');
                loadAnalytics();
            }, 2000);
        }

        function exportAnalytics() {
            showNotification('üìä Exporting analytics data...', 'success');
            setTimeout(() => {
                showNotification('‚úÖ Analytics exported successfully', 'success');
            }, 2000);
        }

        // Real-time functions
        function startRealtimeDemo() {
            addRealtimeMessage('‚ö° Real-time demo started');
            addRealtimeMessage('üîÑ Listening for live updates...');
        }

        function simulateUpdates() {
            const updates = [
                'üé´ New ticket created: TKT-004 - Database Performance Issue',
                'üì¶ Inventory updated: LAPTOP-001 stock reduced to 3 units',
                'üß† AI recommendation generated: MOUSE-001 reorder suggested',
                'üë• Customer activity: CUST-001 logged in',
                'ü§ñ AI analysis completed: 3 maintenance alerts generated',
                '‚ö° Real-time sync: All modules updated'
            ];
            
            updates.forEach((update, index) => {
                setTimeout(() => {
                    addRealtimeMessage(update);
                }, index * 1000);
            });
        }

        function addRealtimeMessage(message) {
            const container = document.getElementById('realtime-messages');
            const timestamp = new Date().toLocaleTimeString();
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        function clearRealtimeLog() {
            document.getElementById('realtime-messages').innerHTML = '';
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Integrated ERP System loaded');
            loadDashboard();
        });
    </script>
</body>
</html>
